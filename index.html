<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Interactivo y Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .process-step {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .process-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
             transition: transform 0.3s ease;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .prose strong { font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; }
        .prose li { margin-bottom: 0.5rem; }
        .looker-container {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .looker-container iframe {
            width: 100%;
            height: 80vh; /* Adjust height as needed */
            border: none;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Diagrama de Proceso y Dashboard</h1>
            <p class="mt-2 text-lg text-gray-600">Integración de Datos: META y AgendaPro</p>
        </header>

        <!-- Diagram Container -->
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Diagrama del Proceso Interactivo</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 items-start mb-16">
            <!-- Phase 1 to 4 code is the same... -->
            <!-- Phase 1: META Extraction -->
            <div class="flex flex-col items-center text-center">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Fase 1: META</h3>
                <div id="phase1" class="process-step bg-white p-6 rounded-xl shadow-lg w-full border-l-4 border-blue-600">
                     <div class="text-blue-600 mb-3"><svg xmlns="http://www.w.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.657 7.343A8 8 0 0117.657 18.657z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1014.12 11.88l-4.242 4.242z" /></svg></div>
                    <h4 class="font-semibold text-lg">Extracción de Datos</h4>
                    <p class="text-sm text-gray-500 mt-1">Conexión a la API Graph para obtener datos de campañas en JSON.</p>
                </div>
            </div>
            <!-- Phase 2: META Storage -->
            <div class="flex flex-col items-center text-center">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Fase 2: Hojas de Cálculo</h3>
                 <div id="phase2" class="process-step bg-white p-6 rounded-xl shadow-lg w-full border-l-4 border-green-500">
                    <div class="text-green-500 mb-3"><svg xmlns="http://www.w.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                    <h4 class="font-semibold text-lg">Almacenamiento META</h4>
                    <p class="text-sm text-gray-500 mt-1">Organización de datos en "Campañas" y "Clientes Potenciales".</p>
                </div>
            </div>
            <!-- Phase 3: AgendaPro Extraction -->
            <div class="flex flex-col items-center text-center">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Fase 3: AgendaPro</h3>
                <div id="phase3" class="process-step bg-white p-6 rounded-xl shadow-lg w-full border-l-4 border-yellow-500">
                    <div class="text-yellow-500 mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" /></svg></div>
                    <h4 class="font-semibold text-lg">Extracción de Datos</h4>
                    <p class="text-sm text-gray-500 mt-1">Script para obtener datos de conductores y guardarlos en una hoja.</p>
                </div>
            </div>
            <!-- Phase 4: Analysis -->
            <div class="flex flex-col items-center text-center">
                 <h3 class="text-xl font-bold mb-4 text-gray-700">Fase 4: Looker</h3>
                <div id="phase4" class="process-step bg-white p-6 rounded-xl shadow-lg w-full border-l-4 border-purple-500">
                    <div class="text-purple-500 mb-3"><svg xmlns="http://www.w.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg></div>
                    <h4 class="font-semibold text-lg">Análisis y Visualización</h4>
                    <p class="text-sm text-gray-500 mt-1">Conexión de las fuentes de datos para crear el dashboard final.</p>
                </div>
            </div>
        </div>

        <!-- AI Button -->
        <div class="text-center mb-16">
             <button id="optimize-process-btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-lg flex items-center justify-center mx-auto gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c.3 0 .5.1.8.4l1.3 2.1c.2.3.5.5.8.6l2.3.4c.6.1.9.8.5 1.2l-1.8 1.5c-.3.2-.4.6-.3.9l.5 2.3c.1.6-.5 1-1.1.7l-2-1.2c-.3-.2-.7-.2-1 0l-2 1.2c-.6.3-1.2-.1-1.1-.7l.5-2.3c.1-.3 0-.7-.3-.9l-1.8-1.5c-.4-.4-.1-1.1.5-1.2l2.3-.4c.3 0 .6-.2.8-.6l1.3-2.1c.3-.3.5-.4.8-.4z"/><path d="M19 12c.3 0 .5.1.8.4l1.3 2.1c.2.3.5.5.8.6l2.3.4c.6.1.9.8.5 1.2l-1.8 1.5c-.3.2-.4.6-.3.9l.5 2.3c.1.6-.5 1-1.1.7l-2-1.2c-.3-.2-.7-.2-1 0l-2 1.2c-.6.3-1.2-.1-1.1-.7l.5-2.3c.1-.3 0-.7-.3-.9l-1.8-1.5c-.4-.4-.1-1.1.5-1.2l2.3-.4c.3 0 .6-.2.8-.6l1.3-2.1c.3-.3.5-.4.8-.4z"/><path d="M5 12c.3 0 .5.1.8.4l1.3 2.1c.2.3.5.5.8.6l2.3.4c.6.1.9.8.5 1.2l-1.8 1.5c-.3.2-.4.6-.3.9l.5 2.3c.1.6-.5 1-1.1.7l-2-1.2c-.3-.2-.7-.2-1 0l-2 1.2c-.6.3-1.2-.1-1.1-.7l.5-2.3c.1-.3 0-.7-.3-.9l-1.8-1.5c-.4-.4-.1-1.1.5-1.2l2.3-.4c.3 0 .6-.2.8-.6l1.3-2.1c.3-.3.5-.4.8-.4z"/></svg>
                Optimizar Proceso con IA
            </button>
        </div>

        <!-- NEW: Looker Studio Dashboard Section -->
        <section class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
             <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Dashboard de Resultados</h2>
             <div class="looker-container">
                <iframe src="https://lookerstudio.google.com/embed/reporting/949631c2-0ebe-4edb-969d-2e95cbae7239/page/p_5s5z7qebwd" frameborder="0" style="border:0" allowfullscreen sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
             </div>
        </section>

    </div>

    <!-- Modals (no changes here) -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-2xl transform scale-95">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-light">&times;</button>
            </div>
            <div id="modal-body" class="p-6 text-gray-700 leading-relaxed"></div>
        </div>
    </div>
    <div id="gemini-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="gemini-modal-content" class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-3xl transform scale-95 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b bg-gray-50 rounded-t-lg">
                <h2 id="gemini-modal-title" class="text-2xl font-bold text-gray-800">✨ Sugerencia de la IA</h2>
                <button id="close-gemini-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-light">&times;</button>
            </div>
            <div id="gemini-modal-body" class="p-6 leading-relaxed overflow-y-auto">
                <div id="loader" class="flex justify-center items-center h-48">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Javascript remains the same...
        const phaseDetails = {
            phase1: {
                title: "Fase 1: Extracción de Datos de META",
                content: `<p class="mb-4">El proceso comienza con la configuración de una aplicación en la plataforma para desarrolladores de META. Esta aplicación actúa como puente para establecer una conexión segura con la API Graph de META.</p><p>Para acceder a los datos de las campañas, es necesario configurar los siguientes parámetros en el Explorador de la API Graph:</p><ul class="list-disc list-inside mt-4 space-y-2 bg-gray-50 p-4 rounded-md"><li><strong>Token de Acceso:</strong> Credencial única que autoriza las solicitudes a la API.</li><li><strong>Aplicación de META:</strong> Se utiliza la aplicación designada "Karri Flut".</li><li><strong>Página de Usuario:</strong> Se especifica el token de acceso a la página "Karri Mexico".</li><li><strong>Permisos:</strong> Se otorgan 8 permisos específicos para asegurar el acceso a los datos de campañas y formularios de clientes potenciales.</li></ul><p class="mt-4 font-semibold">El resultado de esta fase es la obtención de la información en formato JSON.</p>`
            },
            phase2: {
                title: "Fase 2: Almacenamiento de Datos de META",
                content: `<p>Una vez que los datos son extraídos en formato JSON, se procesan y se almacenan en dos hojas de cálculo de Google Sheets separadas para una mejor organización:</p><ol class="list-decimal list-inside mt-4 space-y-2"><li><strong>Listado Campañas y Anuncios:</strong> Contiene toda la información relativa a la estructura de las campañas, los conjuntos de anuncios y los anuncios individuales.</li><li><strong>Lista de Clientes Potenciales:</strong> Almacena los datos de los usuarios que han completado los formularios de contacto (leads).</li></ol>`
            },
            phase3: {
                title: "Fase 3: Extracción de Datos AgendaPro",
                content: `<p>De manera paralela, se ejecuta un script automatizado diseñado para conectarse a la base de datos de AgendaPro.</p><p class="mt-4">Este script extrae la información relevante de los perfiles de los conductores ya registrados en la plataforma y la vuelca en una hoja de cálculo dedicada llamada <strong>"Agenda Pro"</strong>.</p>`
            },
            phase4: {
                title: "Fase 4: Análisis y Visualización",
                content: `<p class="mb-4">En la fase final, las tres hojas de cálculo (dos de META y una de AgendaPro) se conectan como fuentes de datos a la plataforma de inteligencia de negocios <strong>Looker Studio</strong>.</p><p>En esta herramienta se realiza el cruce de la información, permitiendo la creación de un dashboard interactivo. Este dashboard visualiza la comparativa entre las campañas activas y su efectividad, mostrando métricas clave como la <strong>tasa de conversión de "lead" a conductor activo</strong>.</p><!-- ✨ New Gemini Feature --><div class="mt-6 pt-4 border-t border-gray-200"><h4 class="font-bold text-lg text-gray-800">¿Resultados inesperados?</h4><p class="text-sm text-gray-600 mb-2">Describe un resultado o anomalía que observaste en tu dashboard (ej. "La conversión bajó un 20% en la última semana") y la IA sugerirá posibles causas.</p><textarea id="observation-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Describe tu observación aquí..."></textarea><button id="explain-result-btn" class="mt-2 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center gap-2">✨ Explicar Resultado con IA</button></div>`
            }
        };

        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModal = document.getElementById('close-modal');
        const processSteps = document.querySelectorAll('.process-step');

        const geminiModal = document.getElementById('gemini-modal');
        const geminiModalContent = document.getElementById('gemini-modal-content');
        const geminiModalTitle = document.getElementById('gemini-modal-title');
        const geminiModalBody = document.getElementById('gemini-modal-body');
        const closeGeminiModal = document.getElementById('close-gemini-modal');
        const optimizeProcessBtn = document.getElementById('optimize-process-btn');
        const loader = document.getElementById('loader');

        const API_KEY = ""; // Intentionally left blank.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        // --- Gemini Modal Logic ---
        const showGeminiModal = (title) => {
            geminiModalTitle.textContent = title;
            geminiModalBody.innerHTML = '';
            geminiModalBody.appendChild(loader);
            loader.style.display = 'flex';
            geminiModal.classList.remove('opacity-0', 'pointer-events-none');
            geminiModalContent.classList.remove('scale-95');
        };

        const hideGeminiModal = () => {
            geminiModal.classList.add('opacity-0');
            geminiModalContent.classList.add('scale-95');
            setTimeout(() => {
                geminiModal.classList.add('pointer-events-none');
            }, 300);
        };

        closeGeminiModal.addEventListener('click', hideGeminiModal);
        geminiModal.addEventListener('click', (e) => e.target === geminiModal && hideGeminiModal());

        // --- Phase Details Modal Logic ---
        const hideModal = () => {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('pointer-events-none'), 300);
        };
        closeModal.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => e.target === modal && hideModal());
        
        // --- Core Gemini API Call ---
        const callGeminiAPI = async (prompt, title) => {
            showGeminiModal(title);

            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);

                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/### (.*)/g, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>').replace(/## (.*)/g, '<h2 class="text-2xl font-bold mt-6 mb-3">$1</h2>').replace(/\* (.*)/g, '<li>$1</li>').replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>').replace(/\n/g, '<br>');
                    geminiModalBody.innerHTML = `<div class="prose max-w-none">${text}</div>`;
                } else {
                    geminiModalBody.textContent = 'No se pudo obtener una respuesta de la IA. La respuesta podría estar vacía o bloqueada.';
                }
            } catch (error) {
                console.error("Fallo en la llamada a la API de Gemini:", error);
                geminiModalBody.innerHTML = `<p class="text-red-500"><strong>Error:</strong> No se pudo conectar con el servicio de IA. Revisa la consola para más detalles.</p>`;
            } finally {
                loader.style.display = 'none';
            }
        };

        const getProcessContext = () => Object.values(phaseDetails)
            .map(p => `${p.title}: ${p.content.replace(/<[^>]*>/g, ' ').replace(/\s\s+/g, ' ')}`)
            .join('\n');
        
        // --- Event Listeners ---
        optimizeProcessBtn.addEventListener('click', () => {
            const prompt = `Actúa como un experto en ingeniería de datos y optimización de procesos de negocio. Dado el siguiente flujo de trabajo para integrar datos de campañas de META con una base de datos interna (AgendaPro) y analizarlos en Looker Studio, proporciona tres sugerencias específicas y accionables para mejorarlo. Enfócate en la automatización, eficiencia, escalabilidad y calidad de los datos. Para cada sugerencia, explica el beneficio concreto. Formatea tu respuesta de manera clara y profesional usando markdown (títulos, negritas, listas).\n\nProceso Actual:\n${getProcessContext()}`;
            callGeminiAPI(prompt, '✨ Optimizando el Proceso...');
        });

        processSteps.forEach(step => {
            step.addEventListener('click', () => {
                const phaseId = step.id;
                const details = phaseDetails[phaseId];
                modalTitle.textContent = details.title;
                modalBody.innerHTML = details.content;

                if (phaseId === 'phase4') {
                    document.getElementById('explain-result-btn').addEventListener('click', () => {
                        const observationInput = document.getElementById('observation-input');
                        const observation = observationInput.value;
                        if (!observation.trim()) {
                            observationInput.focus();
                            observationInput.classList.add('border-red-500');
                            return;
                        }
                        observationInput.classList.remove('border-red-500');
                        
                        const prompt = `Actúa como un analista de datos y experto en inteligencia de negocios. Un usuario está analizando datos del siguiente pipeline y ha observado un resultado específico. Proporciona 3 a 5 posibles causas raíz para esta observación. Considera problemas potenciales en cada fase del pipeline (Extracción de META, Almacenamiento, Extracción de AgendaPro, y la conexión/configuración en Looker). Sé específico en tus hipótesis y formatea la respuesta en markdown.\n\nPipeline de Datos:\n${getProcessContext()}\n\nObservación del Usuario:\n"${observation}"`;
                        callGeminiAPI(prompt, '✨ Analizando Observación...');
                    });
                }

                modal.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('scale-95');
            });
        });
    </script>
</body>
</html>


